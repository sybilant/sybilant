#!/usr/bin/env bash
# Copyright Â© Paul Stadig.  All rights reserved.
#
# This Source Code Form is subject to the terms of the Mozilla Public License,
# v. 2.0.  If a copy of the MPL was not distributed with this file, You can
# obtain one at http://mozilla.org/MPL/2.0/.
#
# This Source Code Form is "Incompatible With Secondary Licenses", as defined by
# the Mozilla Public License, v. 2.0.

set -e

basedir="$(dirname "${0}")/.."

if [ -z "${1}" ]; then
  echo "Please specify a test to build"
  exit 1
fi

bin_file="${basedir}/test/$(basename "${1}")"
asm_file="${bin_file}.asm"

if [ ! -f "${asm_file}" ]; then
  echo "Test ${1} does not exist"
  exit 1
fi

object_file="${bin_file}.o"

yasm -g dwarf2 -f elf64 -o "${object_file}" "${asm_file}" &&
ld -dynamic-linker /lib64/ld-linux-x86-64.so.2 -lc -o "${bin_file}" \
  "${object_file}"
