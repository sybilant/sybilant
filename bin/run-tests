#!/usr/bin/env bash
if [ -n "$*" ]; then
    for t in $@; do
        test_files="$test_files sybilant/test/$t.syb"
    done
    skip_lein=true
else
    test_files=$(ls sybilant/test/*.syb.asm 2>/dev/null)
fi

function assemble {
    yasm -g dwarf2 -f elf64 -o $2 $1 &&
    ld -dynamic-linker /lib64/ld-linux-x86-64.so.2 -lc -o $3 $2
}

if [ -z "$skip_lein" ]; then
    lein test
fi &&
echo "== Sybilant tests" &&
for test_file in $test_files; do
    name=$(basename $test_file .syb.asm)
    echo -n "$name..."
    bin_file=$(dirname $test_file)/../../target/sybilant/test/$name
    mkdir -p $(dirname $bin_file)
    object_file=$bin_file.o
    stats_file=$bin_file.stats
    if (assemble $test_file $object_file $bin_file &&
            /usr/bin/env time -v -o $stats_file ./$bin_file); then
        echo "passed ($(grep "Elapsed (wall clock) time" $stats_file | \
cut -f8 -d" "))"
    else
        echo "failed!!"
        failed=true
    fi
done &&
if [ -z "$failed" ]; then
    echo "== Testing complete"
else
    echo "!! Tests failed"
fi
